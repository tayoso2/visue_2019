---
title: "N1 EHV Transformers with Tapchangers Data Analysis"
output:
  html_document:
    number_sections: yes
    theme: yeti
    toc: yes
    toc_float: yes
---
---
  
```{r headers, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}
#BeginHeader
#Input#DataTable#Name:60kV Transformers Asset Base#Description:60kV Transformers raw asset data.
#Output#DataTable#Name:60kV Transformers Population Summary#Description:Summary of population for each field of the data.
#Output#DataTable#Name:60kV Transformers#Description:60kV Transformers asset base for the model.
#Output#DataTable#Name:60kV Transformers GIS#Description:60kV Transformers GIS.
#EndHeader


#rm(list = ls())

EDA <- F# set to TRUE if running in EDA data labs

if (EDA) {
  args <- commandArgs(trailingOnly = TRUE)
} else {
  args <- c(getwd(),
            "Data/Asset Bases/EHV Transformers_Raw Assets v2 (EDA Version v1 - ORIGINAL) 1807 default_infilled.csv",
            "Output Data/60kV Transformers Population Summary 1807 default_infilled.csv",
            "Output Data/60kV Transformers For Model 1807 .csv", 
            "Output Data/60kV Transformers GIS 1807.csv")
}


setwd(args[1])
```


```{r load.data, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}
library(tidyverse)
library(data.table)
library(ggplot2)
library(DescTools)
library(knitr)
library(stringi)
library(sf)
library(stringr)

library(kableExtra)

tx.assets <- data.table(read_csv(args[2], locale=locale(encoding="Latin1")))

## remove any completely empty rows and make asset id unique throughout
tx.assets <- tx.assets[!apply(is.na(tx.assets) | tx.assets == "", 1, all),]
tx.assets$Asset_Number <- make.unique(as.character(tx.assets$Asset_Number))

# calculate average year of manufacture (excluding 0, NA & default values)
tx.assets.copy <- tx.assets
tx.assets.copy$Transformer_Year_Of_Manufacture[tx.assets.copy$Transformer_Year_Of_Manufacture==0] <- NA
tx.assets.copy$Tapchanger_Year_Of_Manufacture[tx.assets.copy$Tapchanger_Year_Of_Manufacture==0] <- NA
trans.average.year <- round(mean(as.numeric(tx.assets.copy$Transformer_Year_Of_Manufacture), na.rm=T))
tap.average.year <- round(mean(as.numeric(tx.assets.copy$Tapchanger_Year_Of_Manufacture), na.rm=T))

# calculate average number of customers (excluding 0, NA & default values)
tx.assets.copy$Number_Of_Customers[tx.assets.copy$Number_Of_Customers==0] <- NA
mean.average.customers <- mean(as.numeric(tx.assets.copy$Number_Of_Customers), na.rm=T)
average.customers <- round(mean.average.customers,0)

##Strip out danish characters to limit problems.
#ae
tx.assets <- tx.assets[, lapply(.SD,   function(x){gsub("Æ", "AE", gsub("æ", "ae", x))}),  .SDcols = 1:ncol(tx.assets)]
names(tx.assets) <- gsub("Æ", "AE", gsub("æ", "ae", names(tx.assets)))

#aa
tx.assets <- tx.assets[, lapply(.SD,   function(x){gsub("Å", "AA", gsub("å", "aa", x))}),  .SDcols = 1:ncol(tx.assets)]
names(tx.assets) <- gsub("Å", "AA", gsub("å", "aa", names(tx.assets)))

#oe
tx.assets <- tx.assets[, lapply(.SD,   function(x){gsub("Ø", "OE", gsub("ø", "oe", x))}),  .SDcols = 1:ncol(tx.assets)]
names(tx.assets) <- gsub("Ø", "OE", gsub("ø", "oe", names(tx.assets)))

tx.assets <- as.tibble(tx.assets)
```

# **Asset Quantity**

There are **`r nrow(tx.assets)`** records in the source data. Ignoring NA or default values:

* The average transformer year of manufacture is **`r trans.average.year`**.

* The average tapchanger year of manufacture is **`r tap.average.year`**.

* The average number of customers  is **`r average.customers`**.

---

# **Population Summary**

The chart below shows the fields provided in each source data item and indicates how populated each field is. An entry is deemed as unpopulated if it is either NA or blank.

```{r warning=FALSE, echo=FALSE, message = FALSE, fig.height = 18}
tx.assets[tx.assets == ""] <-  NA
Unpopulated <- apply(tx.assets, 2, function(x) (mean(is.na(x)))*100)
Default <- apply(tx.assets, 2, function(x) (mean(x == "Default"))*100)
Default <- ifelse(is.na(Default), 0, Default)
Populated <- 100 - Unpopulated - Default
Field <- names(Unpopulated)
data.pop <- data.frame(Field, Unpopulated, Populated, Default)
data.pop <- gather(data.pop, variable, value, -Field) %>%
  mutate(variable = factor(variable, levels = c("Unpopulated", "Populated", "Default"), ordered = TRUE)) 

write_csv(data.pop, args[3])

ggplot(data = data.pop, aes(x = Field, y = value, fill = variable)) + 
    geom_bar(stat = "identity") + coord_flip() +
  labs(main = "Percentage Population", y="Percentage", fill="Population Levels")
```

```{r GIS, message=FALSE, warning=FALSE, echo=FALSE}


# Function to make Qlik map line format from WKT geometry -----------------


QlikLineFormat <- function(wkt) {
 # Converts WKT (well-known text) line geometry to the format required by Qlik
 #
 # Args:
 #   wkt: Character vector of 2d line geometry in WKT format
 #
 # Returns:
 #   A character vector of same length as wkt containing line geometry in format
 #   which can be visualised by Qlik.
  
  # Remove unrequired text from wkt
  qlik.line <- str_replace(wkt, "POINT ", "")
  qlik.line <- str_replace(qlik.line, "\\(", "")
  qlik.line <- str_replace(qlik.line, "\\)", "")
  # Split into list based on comma seperated values
  qlik.line <- str_split(qlik.line, ",")
  
  # Inner function to add markup to each item in the list
  sq.brackets <- function(x) {
    x <- str_replace(x, "^ ", "")
    x <- str_replace(x, " ", ",")
    x <- paste0("[", x, "]")
    x <- str_flatten(x, collapse = ",")
  }
  
  # Apply Qlik markup to wkt
  qlik.line <- lapply(qlik.line, sq.brackets)
  # Convert list to vector
  qlik.line <- unlist(qlik.line)
  
  return(qlik.line)
}

str_flatten <- function(string, collapse = "") {
  stri_flatten(string, collapse = collapse)
}

```



## Asset ID

Asset_Number is the unique identifier. There is a total of **`r length(tx.assets$Asset_Number)`** rows in the transformers & tapchangers source data. There are **`r length(unique(tx.assets$Asset_Number))`** unique values for Asset_Number.

## Transformer Corrosion

```{r tx corrosion, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(tx.assets, aes(factor(Transformer_Corrosion_Index))) +
  geom_bar() +
  labs(title="Count of 60kV Transformers by Corrosion Category", y="Count", x="Corrosion Index")

```

## Tapchanger Corrosion

```{r tc corrosion, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(tx.assets, aes(factor(Tapchanger_Corrosion_Index))) +
  geom_bar() +
  labs(title="Count of 60kV Tapchangers by Corrosion Category", y="Count", x="Corrosion Index")

```

## Transformer Distance from Coast

```{r tx dist.from.coast, message=FALSE, warning=FALSE, echo=FALSE}
#PlotFdist(as.numeric(tx.assets$Transformer_Distance_From_Coast), na.rm = TRUE,
#          main = "Distribution of 60kV Transformers by Distance from Coast")
```

## Tapchanger Distance from Coast

```{r tc dist.from.coast, message=FALSE, warning=FALSE, echo=FALSE}
#PlotFdist(as.numeric(tx.assets$Tapchanger_Distance_From_Coast), na.rm = TRUE,
#          main = "Distribution of 60kV Tapchangers by Distance from Coast")
```

## Indoor/Outdoor

```{r tx indoor.outdoor, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(tx.assets, aes(Transformer_Position)) +
  geom_bar() +
  labs(title="Count of 60kV Transformers by Indoor/Outdoor (OD=Outdoor, ID=Indoor)", y="Count", x="Position")
```

```{r tc indoor.outdoor, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(tx.assets, aes(Tapchanger_Position)) +
  geom_bar() +
  labs(title="Count of 60kV Tapchangers by Indoor/Outdoor (OD=Outdoor, ID=Indoor)", y="Count", x="Position")
```

## Transformer Year Of Manufacture

```{r tx age, message=FALSE, warning=FALSE, echo=FALSE}
tx.assets$Transformer_Year_Of_Manufacture[tx.assets$Transformer_Year_Of_Manufacture==0] <- NA
PlotFdist(as.integer(tx.assets$Transformer_Year_Of_Manufacture), na.rm = TRUE,
          main = "Distribution of 60kV Transformers by Age")
```

## Tapchanger Year Of Manufacture

```{r tc age, message=FALSE, warning=FALSE, echo=FALSE}
tx.assets$Tapchanger_Year_Of_Manufacture[tx.assets$Tapchanger_Year_Of_Manufacture==0] <- NA
PlotFdist(as.integer(tx.assets$Tapchanger_Year_Of_Manufacture), na.rm = TRUE,
          main = "Distribution of 60kV Tapchangers by Age")
```


## Transformer Tank Condition 
```{r tx tnk, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(tx.assets, aes(factor(`Tank Condition Factor`))) +
  geom_bar() +
  labs(title="Count of 60kV Transformers by Tank Condition", y="Count", x="Tank Condition")

```

## Tapchanger External Condition 

```{r tc ext, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(tx.assets, aes(factor(`Tapchanger External Condition Factor`))) +
  geom_bar() +
  labs(title="Count of 60kV Tapchangers by External Condition", y="Count", x="External Condition")

```

---

# **Creation of Model Asset Base**

```{r model, warning=FALSE, echo=FALSE, message = FALSE}
assets <- tx.assets

raw.model.data <- data.table(Area1 = "N1",
                          Type = "Transformer",
                          Asset_Number = assets$Asset_Number,
                          Manufacturer = assets$Manufacturer,
                          Relation_3 = assets$Relation_3, 
                          Driftsmrk = assets$Code,
                          Code = assets$Code,
                          N1_Group = "60kV Station",
                          Health_Index_Asset_Category = assets$Health_Index_Asset_Category,
                          Asset_Register_Category = assets$Asset_Register_Category,
                          SubDivision = ifelse(assets$Transformer_Year_Of_Manufacture <= 1980 & !is.na(assets$Transformer_Year_Of_Manufacture), "Transformer - Pre 1980", ifelse(assets$Transformer_Year_Of_Manufacture > 1980 & !is.na(assets$Transformer_Year_Of_Manufacture), "Transformer - Post 1980", "Default")),
                          Voltage = gsub("\\s(.*)", "", assets$Asset_Register_Category),
                          Transformer_Year_Of_Manufacture = assets$Transformer_Year_Of_Manufacture,
                          Tapchanger_Year_Of_Manufacture = assets$Tapchanger_Year_Of_Manufacture,
                          Transformer_Coast_Side = assets$Transformer_Coast_Side,
                          Tapchanger_Coast_Side = assets$Tapchanger_Coast_Side,
                          Transformer_Altitude = "Default",
                          Transformer_Corrosion_Index = assets$Transformer_Corrosion_Index,
                          Transformer_Distance_From_Coast = assets$Transformer_Distance_From_Coast,
                          Tapchanger_Altitude = "Default",
                          Tapchanger_Corrosion_Index = assets$Tapchanger_Corrosion_Index,
                          Tapchanger_Distance_From_Coast = assets$Tapchanger_Distance_From_Coast,
                          Transformer_Position = assets$Transformer_Position,
                          Tapchanger_Position = assets$Tapchanger_Position,
                          Transformer_Duty_Factor = assets$Transformer_Duty_Factor,
                          Tapchanger_Duty_Factor = assets$Tapchanger_Duty_Factor,
                          Number_Of_Customers = assets$Number_Of_Customers,
                          Top_30_Customers_Factor = assets$Top_30_Customers_Factor,
                          Type_Financial_Factor = assets$Type_Financial_Factor,
                          Transformer_Type_Factor = assets$Transformer_Type_Factor,
                          Tapchanger_Type_Factor = assets$Tapchanger_Type_Factor,
                          Access_Financial_Factor = assets$Access_Financial_Factor,
                          Location_Safety_Rating = assets$Location_Safety_Rating,
                          Type_Safety_Rating = assets$Type_Safety_Rating,
                          Size_Environmental_Factor = assets$Size_Environmental_Factor,
                          Proximity_to_Water_Course = assets$Proximity_to_Water_Course,
                          Bunding_Factor = assets$Bunding_Factor,
                          Actual_Load = assets$Actual_Load,
                          Network_Type_Factor = assets$Network_Type_Factor,
                          `Quantity Resource` = assets$`Quantity Resource`,
                          `Tank Condition Factor` = assets$`Tank Condition Factor`,
                          `Coolers_Radiator Condition Factor` = assets$`Coolers_Radiator Condition Factor`,
                          `Bushings Condition Factor` = assets$`Bushings Condition Factor`,
                          `Kiosk Condition Factor` = assets$`Kiosk Condition Factor`,
                          `Cablebox Condition Factor` = assets$`Cablebox Condition Factor`,
                          `Tapchanger External Condition Factor` = assets$`Tapchanger External Condition Factor`,
                          `Tapchanger Internal Condition Factor` = assets$`Tapchanger Internal Condition Factor`,
                          `Tapchanger Drive Mechanism Condition Factor` = assets$`Tapchanger Drive Mechanism Condition Factor`,
                          `Tapchanger Selector_Divertor Contacts Factor` = assets$`Tapchanger Selector_Divertor Contacts Factor`,
                          `Tapchanger Selector_Divertor Braids Factor` = assets$`Tapchanger Selector_Divertor Braids Factor`,
                          `Partial Discharge Factor` = assets$`Partial Discharge Factor` ,	
                          `Temperature Readings Factor` = assets$`Temperature Readings Factor`,
                          `Tapchanger Partial Discharge Factor` = assets$`Tapchanger Partial Discharge Factor`,
                          `Oil Acidity` = assets$`Oil Acidity`,
                          Moisture = assets$`Moisture`,
                          `Breakdown Strength` = assets$`Breakdown Strength`,
                          `Tapchanger Oil Acidity` = assets$`Tapchanger Oil Acidity`,
                          `Tapchanger Moisture` = assets$`Tapchanger Moisture`,
                          `Tapchanger Breakdown Strength` = assets$`Tapchanger Breakdown Strength`,
                          Hydrogen = assets$`Hydrogen`,	
                          Methane = assets$`Methane`,
                          Ethylene = assets$`Ethylene`,
                          Ethane = assets$`Ethane`,
                          Acetylene = assets$`Acetylene`,	
                          `2nd_Hydrogen` = assets$`2nd_Hydrogen`,	
                          `2nd_Methane` = assets$`2nd_Methane`,	
                          `2nd_Ethylene` = assets$`2nd_Ethylene`,	
                          `2nd_Ethane` = assets$`2nd_Ethane`,
                          `2nd_Acetylene` = assets$`2nd_Acetylene`,
                          FFA = assets$FFA, 
                          `Reliability Modifier` = assets$`Reliability Modifier`,	
                          `Reliability Collar` = assets$`Reliability Collar`,
                          `Tapchanger Reliability Modifier` = assets$`Tapchanger Reliability Modifier`,	
                          `Tapchanger Reliability Collar` = assets$`Tapchanger Reliability Collar`,
check.names = F, stringsAsFactors = F)
                          
table.data <- data.frame(`Model Field Name` = colnames(raw.model.data),
                         `Data Used` = c("'N1' for all assets",
                                         "'Transformer' for all assets",
                                         "Asset_Number",
                                         "Manufacturer",
                                         "Relation_3",
                                         "Driftsmrk",
                                         "Code",
                                         "60kV Station",
                                         "Health_Index_Asset_Category",
                                         "Asset_Register_Category",
                                         "Banded using Transformer_Year_Of_Manufacture",
                                         "First word of the Asset_Register_Category",
                                         "Transformer_Year_Of_Manufacture",
                                         "Tapchanger_Year_Of_Manufacture",
                                         "Transformer_Coast_Side",
                                         "Tapchanger_Coast_Side",
                                         "'Default' for all assets",
                                         "Transformer_Corrosion_Index",
                                         "Transformer_Distance_From_Coast",
                                         "'Default' for all assets",
                                         "Tapchanger_Corrosion_Index",
                                         "Tapchanger_Distance_From_Coast",
                                         "Transformer_Position",
                                         "Tapchanger_Position",
                                         "Transformer_Duty_Factor",
                                         "Tapchanger_Duty_Factor",
                                         "Number_Of_Customers",
                                         "Top_30_Customers_Factor",
                                         "Type_Financial_Factor",
                                         "Transformer_Type_Factor",
                                         "Tapchanger_Type_Factor",
                                         "Access_Financial_Factor",
                                         "Location_Safety_Rating",
                                         "Type_Safety_Rating",
                                         "Size_Environmental_Factor",
                                         "Proximity_to_Water_Course",
                                         "Bunding_Factor",
                                         "Actual_Load",
                                         "Network_Type_Factor",
                                         "Quantity Resource",
                                         "Tank Condition Factor",
                                         "Coolers_Radiator Condition Factor",
                                         "Bushings Condition Factor",
                                         "Kiosk Condition factor",
                                         "Cablebox Condition Factor",
                                         "Tapchanger External Condition Factor",
                                         "Tapchanger Internal Condition Factor",
                                         "Tapchanger Drive Mechanism Condition Factor",
                                         "Tapchanger Selector_Divertor Contacts Factor",
                                         "Tapchanger Selector_Divertor Braids Factor",
                                         "Partial Discharge Factor",
                                         "Temperature Readings Factor",
                                         "Tapchanger Partial Discharge Factor",
                                         "Oil Acidity",
                                         "Moisture",
                                         "Breakdown Strength",
                                         "Tapchanger Oil Acidity",
                                         "Tapchanger Moisture",
                                         "Tapchanger Breakdown Strength",
                                         "Hydrogen",
                                         "Methane",
                                         "Ethylene",
                                         "Ethane",
                                         "Acetylene",
                                         "2nd_Hydrogen",
                                         "2nd_Methane",
                                         "2nd_Ethylene",
                                         "2nd_Ethane",
                                         "2nd_Acetylene",
                                         "FFA",
                                         "Reliability Modifier",	
                                         "Reliability Collar",
                                         "Tapchanger Reliability Modifier",	
                                         "Tapchanger Reliability Collar"), check.names = F)

kable(table.data, "html") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"))

model.data <- raw.model.data
```

```{r manufacturer infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

manufacturer.default <- sum(is.na(model.data$Manufacturer))

model.data$Manufacturer <- ifelse(!is.na(model.data$Manufacturer),
                                    model.data$Manufacturer,
                                    model.default)
```

```{r relation infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

relation.default <- sum(is.na(model.data$Relation_3))

model.data$Relation_3 <- ifelse(!is.na(model.data$Relation_3),
                                  model.data$Relation_3,
                                  model.default)
```

```{r code infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

code.default <- sum(is.na(model.data$Code))

model.data$Code <- ifelse(!is.na(model.data$Code),
                                  model.data$Code,
                                  model.default)
```

```{r health category infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- "EHV Transformer"
model.default <- "EHV Transformer"

health.category.default <- sum(!(model.data$Health_Index_Asset_Category %in% model.accepts))

model.data$Health_Index_Asset_Category <- ifelse(model.data$Health_Index_Asset_Category %in% model.accepts,
                                    model.data$Health_Index_Asset_Category,
                                    model.default)
```

```{r asset category infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- "60kV Transformer (GM)"
model.default <- "60kV Transformer (GM)"

asset.category.default <- sum(!(model.data$Asset_Register_Category %in% model.accepts))

model.data$Asset_Register_Category <- ifelse(model.data$Asset_Register_Category %in% model.accepts,
                                    model.data$Asset_Register_Category,
                                    model.default)
```

```{r voltage infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <-"60kV"
model.default <- "60kV"

voltage.default <- sum(!(model.data$Voltage %in% model.accepts))

model.data$Voltage <- ifelse(model.data$Voltage %in% model.accepts,
                                    model.data$Voltage,
                                    model.default)
```

```{r tx coast infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("East", "West")
model.default <- "Default"

tx.coast.default <- sum(!(model.data$Transformer_Coast_Side %in% model.accepts))

model.data$Transformer_Coast_Side <- ifelse(!is.na(model.data$Transformer_Coast_Side),
                                    model.data$Transformer_Coast_Side,
                                    model.default)
```

```{r tc coast infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("East", "West")
model.default <- "Default"

tc.coast.default <- sum(!(model.data$Tapchanger_Coast_Side %in% model.accepts))

model.data$Tapchanger_Coast_Side <- ifelse(!is.na(model.data$Tapchanger_Coast_Side),
                                    model.data$Tapchanger_Coast_Side,
                                    model.default)
```

```{r tx year infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default" # model cannot run with this! Will need a default - done below

tx.year.default <- sum(is.na(as.numeric(model.data$Transformer_Year_Of_Manufacture)))

# change NA year values to average across asset base; 0 is used as a default value, so change this to NA
model.data$Transformer_Year_Of_Manufacture[model.data$Transformer_Year_Of_Manufacture==0] <- NA
model.data$Transformer_Year_Of_Manufacture <- as.numeric(model.data$Transformer_Year_Of_Manufacture)
model.data$Transformer_Year_Of_Manufacture[is.na(model.data$Transformer_Year_Of_Manufacture)] <- round(mean(model.data$Transformer_Year_Of_Manufacture, na.rm=T))

model.data$Transformer_Year_Of_Manufacture <- ifelse(!is.na(as.numeric(model.data$Transformer_Year_Of_Manufacture)),
                                    model.data$Transformer_Year_Of_Manufacture,
                                    model.default)
```

```{r tc year infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default" # model cannot run with this! Will need a default - done below

tc.year.default <- sum(is.na(as.numeric(model.data$Tapchanger_Year_Of_Manufacture)))

# change NA year values to average across asset base; 0 is used as a default value, so change this to NA
model.data$Tapchanger_Year_Of_Manufacture[model.data$Tapchanger_Year_Of_Manufacture==0] <- NA
model.data$Tapchanger_Year_Of_Manufacture <- as.numeric(model.data$Tapchanger_Year_Of_Manufacture)
model.data$Tapchanger_Year_Of_Manufacture[is.na(model.data$Tapchanger_Year_Of_Manufacture)] <- round(mean(model.data$Tapchanger_Year_Of_Manufacture, na.rm=T))

model.data$Tapchanger_Year_Of_Manufacture <- ifelse(!is.na(as.numeric(model.data$Tapchanger_Year_Of_Manufacture)),
                                    model.data$Tapchanger_Year_Of_Manufacture,
                                    model.default)
```

```{r subdivision infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("Transformer - Pre 1980", "Transformer - Post 1980")
model.default <- "Default" # model cannot run with this! Will need a default - done below

subdivision.default <- sum(!(model.data$SubDivision %in% model.accepts))

# recalculate subdivision, as the age data has now been populated above (none will be default)
model.data$SubDivision[model.data$SubDivision=="Default"] <- ifelse(model.data$Transformer_Year_Of_Manufacture <= 1980 & !is.na(model.data$Transformer_Year_Of_Manufacture), "Transformer - Pre 1980", ifelse(model.data$Transformer_Year_Of_Manufacture > 1980 & !is.na(model.data$Transformer_Year_Of_Manufacture), "Transformer - Post 1980", "Default"))

model.data$SubDivision <- ifelse(model.data$SubDivision %in% model.accepts,
                                    model.data$SubDivision,
                                    model.default)
```

```{r tx altitude infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

tx.altitude.default <- sum(is.na(as.numeric(model.data$Transformer_Altitude)) | model.data$Transformer_Altitude=="Default")

model.data$Transformer_Altitude <- ifelse(!is.na(as.numeric(model.data$Transformer_Altitude)),
                                    model.data$Transformer_Altitude,
                                    model.default)
```

```{r tc altitude infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

# change 0 to NA as 0 is used as a default value
model.data$Tapchanger_Altitude[model.data$Tapchanger_Altitude==0] <- NA

tc.altitude.default <- sum(is.na(as.numeric(model.data$Tapchanger_Altitude)) | model.data$Tapchanger_Altitude=="Default")

model.data$Tapchanger_Altitude <- ifelse(!is.na(as.numeric(model.data$Tapchanger_Altitude)),
                                    model.data$Tapchanger_Altitude,
                                    model.default)
```

```{r tx corrosion infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- 1:5
model.default <- "Default"

tx.corrosion.default <- sum(!(model.data$Transformer_Corrosion_Index %in% model.accepts))

model.data$Transformer_Corrosion_Index <- ifelse(model.data$Transformer_Corrosion_Index %in% model.accepts,
                                    model.data$Transformer_Corrosion_Index,
                                    model.default)
```

```{r tc corrosion infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- 1:5
model.default <- "Default"

tc.corrosion.default <- sum(!(model.data$Tapchanger_Corrosion_Index %in% model.accepts))

model.data$Tapchanger_Corrosion_Index <- ifelse(model.data$Tapchanger_Corrosion_Index %in% model.accepts,
                                    model.data$Tapchanger_Corrosion_Index,
                                    model.default)
```

```{r tx distance infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

tx.distance.default <- sum(is.na(as.numeric(model.data$Transformer_Distance_From_Coast)))

model.data$Transformer_Distance_From_Coast <- ifelse(!is.na(as.numeric(model.data$Transformer_Distance_From_Coast)),
                                    model.data$Transformer_Distance_From_Coast,
                                    model.default)
```

```{r tc distance infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

tc.distance.default <- sum(is.na(as.numeric(model.data$Tapchanger_Distance_From_Coast)))

model.data$Tapchanger_Distance_From_Coast <- ifelse(!is.na(as.numeric(model.data$Tapchanger_Distance_From_Coast)),
                                    model.data$Tapchanger_Distance_From_Coast,
                                    model.default)
```

```{r tx position infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("ID", "OD")
model.default <- "OD"

tx.position.default <- sum(!(model.data$Transformer_Position %in% model.accepts))

model.data$Transformer_Position <- ifelse(model.data$Transformer_Position %in% model.accepts,
                                    model.data$Transformer_Position,
                                    model.default)
```

```{r tc position infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("ID", "OD")
model.default <- "OD"

tc.position.default <- sum(!(model.data$Tapchanger_Position %in% model.accepts))

model.data$Tapchanger_Position <- ifelse(model.data$Tapchanger_Position %in% model.accepts,
                                    model.data$Tapchanger_Position,
                                    model.default)
```

```{r tx duty infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

model.data$Transformer_Duty_Factor <- gsub("%", "", model.data$Transformer_Duty_Factor)
model.data$Transformer_Duty_Factor <- as.numeric(model.data$Transformer_Duty_Factor)

# change to factor
model.data$Transformer_Duty_Factor[model.data$Transformer_Duty_Factor<=50 & !is.na(model.data$Transformer_Duty_Factor)] <- 1
model.data$Transformer_Duty_Factor[model.data$Transformer_Duty_Factor>50 & model.data$Transformer_Duty_Factor<=70 & !is.na(model.data$Transformer_Duty_Factor)] <- 1.05
model.data$Transformer_Duty_Factor[model.data$Transformer_Duty_Factor>70 & model.data$Transformer_Duty_Factor<=100 & !is.na(model.data$Transformer_Duty_Factor)] <- 1.1
model.data$Transformer_Duty_Factor[model.data$Transformer_Duty_Factor>100 & !is.na(model.data$Transformer_Duty_Factor)] <- 1.4

tx.duty.default <- sum(is.na(as.numeric(model.data$Transformer_Duty_Factor)))

model.data$Transformer_Duty_Factor <- ifelse(!is.na(as.numeric(model.data$Transformer_Duty_Factor)),
                                    model.data$Transformer_Duty_Factor,
                                    model.default)
```

```{r tc duty infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

# change 0 to NA as 0 is used as a default value
model.data$Tapchanger_Duty_Factor[model.data$Tapchanger_Duty_Factor==0] <- NA
model.data$Tapchanger_Duty_Factor <- as.numeric(model.data$Tapchanger_Duty_Factor)

# change to factor
model.data$Tapchanger_Duty_Factor[model.data$Tapchanger_Duty_Factor<=7] <- 0.9
model.data$Tapchanger_Duty_Factor[model.data$Tapchanger_Duty_Factor>7 & model.data$Tapchanger_Duty_Factor<=14] <- 1
model.data$Tapchanger_Duty_Factor[model.data$Tapchanger_Duty_Factor>14 & model.data$Tapchanger_Duty_Factor <=28] <- 1.2
model.data$Tapchanger_Duty_Factor[model.data$Tapchanger_Duty_Factor>28] <- 1.3

tc.duty.default <- sum(is.na(as.numeric(model.data$Tapchanger_Duty_Factor)))

model.data$Tapchanger_Duty_Factor <- ifelse(!is.na(as.numeric(model.data$Tapchanger_Duty_Factor)),
                                    model.data$Tapchanger_Duty_Factor,
                                    model.default)
```

```{r customers infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

customers.default <- sum(is.na(as.numeric(model.data$Number_Of_Customers)))
model.data$Number_Of_Customers <- as.numeric(model.data$Number_Of_Customers)

# change NA customer values to average across asset base
model.data$Number_Of_Customers[is.na(model.data$Number_Of_Customers)] <- round(mean(model.data$Number_Of_Customers, na.rm=T))
```

```{r top 30 infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 1

top.30.default <- sum(is.na(as.numeric(model.data$Top_30_Customers_Factor)))

model.data$Top_30_Customers_Factor <- ifelse(!is.na(as.numeric(model.data$Top_30_Customers_Factor)),
                                    model.data$Top_30_Customers_Factor,
                                    model.default)
```

```{r type financial infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("66/11 or 6.6kV <= 10MVA CMR equivalent", "66/11 or 6.6kV > 10MVA and <= 20MVA CMR equivalent",
                  "66/11 or 6.6kV > 20MVA CMR equivalent")
model.default <- "Default"

model.accepts <- gsub(",", "", model.accepts)
model.accepts <- gsub("=", "", model.accepts)
model.data$Type_Financial_Factor <- gsub(",", "", model.data$Type_Financial_Factor)
model.data$Type_Financial_Factor <- gsub("=", "", model.data$Type_Financial_Factor)

type.financial.default <- sum(!(model.data$Type_Financial_Factor %in% model.accepts))

model.data$Type_Financial_Factor <- ifelse(model.data$Type_Financial_Factor %in% model.accepts,
                                    model.data$Type_Financial_Factor,
                                    model.default)
```

```{r tx type infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 1

tx.type.default <- sum(is.na(model.data$Transformer_Type_Factor) | model.data$Transformer_Type_Factor=="" | model.data$Transformer_Type_Factor=="Default")

model.data$Transformer_Type_Factor <- ifelse(model.data$Transformer_Type_Factor %in% model.accepts,
                                    model.data$Transformer_Type_Factor,
                                    model.default)
```

```{r tc type infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 1

tc.type.default <- sum(is.na(model.data$Tapchanger_Type_Factor) | model.data$Tapchanger_Type_Factor=="" | model.data$Tapchanger_Type_Factor=="Default")

model.data$Tapchanger_Type_Factor <- ifelse(model.data$Tapchanger_Type_Factor %in% model.accepts,
                                    model.data$Tapchanger_Type_Factor,
                                    model.default)
```

```{r access financial infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("A", "B", "C")
model.default <- "A"

access.financial.default <- sum(!(model.data$Access_Financial_Factor %in% model.accepts))

model.data$Access_Financial_Factor <- ifelse(model.data$Access_Financial_Factor %in% model.accepts,
                                    model.data$Access_Financial_Factor,
                                    model.default)
```

```{r loc safety infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("High", "Medium", "Low")
model.default <- "Medium"

location.safety.default <- sum(!(model.data$Location_Safety_Rating %in% model.accepts))

model.data$Location_Safety_Rating <- ifelse(model.data$Location_Safety_Rating %in% model.accepts,
                                    model.data$Location_Safety_Rating,
                                    model.default)
```

```{r type safety infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("High", "Medium", "Low")
model.default <- "Medium"

type.safety.default <- sum(!(model.data$Type_Safety_Rating %in% model.accepts))

model.data$Type_Safety_Rating <- ifelse(model.data$Type_Safety_Rating %in% model.accepts,
                                    model.data$Type_Safety_Rating,
                                    model.default)
```

```{r size env infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("66/11 or 6.6kV <= 10MVA CMR equivalent", "66/11 or 6.6kV > 10MVA and <= 20MVA CMR equivalent",
                  "66/11 or 6.6kV > 20MVA CMR equivalent")
model.default <- "Default"

model.accepts <- gsub(",", "", model.accepts)
model.accepts <- gsub("=", "", model.accepts)
model.data$Size_Environmental_Factor <- gsub(",", "", model.data$Size_Environmental_Factor)
model.data$Size_Environmental_Factor <- gsub("=", "", model.data$Size_Environmental_Factor)

model.data$Size_Environmental_Factor <- ifelse(model.data$Size_Environmental_Factor %in% model.accepts, model.data$Size_Environmental_Factor,
                                               ifelse(as.numeric(model.data$Size_Environmental_Factor) <= 5000, model.accepts[1],
                                                      ifelse(as.numeric(model.data$Size_Environmental_Factor) <= 8000, model.accepts[2],
                                                             ifelse(as.numeric(model.data$Size_Environmental_Factor) > 8000, model.accepts[3], model.default))))

size.environmental.default <- sum(!(model.data$Size_Environmental_Factor %in% model.accepts))
# 
# model.data$Size_Environmental_Factor <- ifelse(model.data$Size_Environmental_Factor %in% model.accepts,
#                                     model.data$Size_Environmental_Factor,
#                                     model.default)
```

```{r proximity infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("Very Close to Water Course (<40m)", "Not Close to Water Course (>120m) or No Oil", "Close to Water Course (between 40m and 80m)", "Moderately Close to Water Course (between 80m and 120m)")
model.default <- "Default"

model.data$Proximity_to_Water_Course[model.data$Proximity_to_Water_Course=="Very Close to Water Course"] <- model.accepts[1]
model.data$Proximity_to_Water_Course[model.data$Proximity_to_Water_Course=="Not Close to Water Course"] <- model.accepts[2]
model.data$Proximity_to_Water_Course[model.data$Proximity_to_Water_Course=="Close to Water Course"] <- model.accepts[3]
model.data$Proximity_to_Water_Course[model.data$Proximity_to_Water_Course=="Moderately Close to Water Course"] <- model.accepts[4]

proximity.default <- sum(!(model.data$Proximity_to_Water_Course %in% model.accepts))

model.data$Proximity_to_Water_Course <- ifelse(model.data$Proximity_to_Water_Course %in% model.accepts,
                                    model.data$Proximity_to_Water_Course,
                                    model.default)
```

```{r bunding infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("Bunded", "Not Bunded")
model.default <- "Default"

bunding.default <- sum(!(model.data$Bunding_Factor %in% model.accepts))

model.data$Bunding_Factor <- ifelse(model.data$Bunding_Factor %in% model.accepts,
                                    model.data$Bunding_Factor,
                                    model.default)
```

```{r actual load infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

# change 0 to NA as 0 is used as a default value
model.data$Actual_Load[model.data$Actual_Load==0] <- NA

actual.load.default <- sum(is.na(as.numeric(model.data$Actual_Load)))

model.data$Actual_Load <- ifelse(!is.na(as.numeric(model.data$Actual_Load)),
                                    model.data$Actual_Load,
                                    model.default)
```

```{r network infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("Secure", "Not Secure")
model.default <- "Secure"

model.data$Network_Type_Factor[model.data$Network_Type_Factor=="Unsecure"] <- "Not Secure"

network.default <- sum(!(model.data$Network_Type_Factor %in% model.accepts))

model.data$Network_Type_Factor <- ifelse(model.data$Network_Type_Factor %in% model.accepts,
                                    model.data$Network_Type_Factor,
                                    model.default)
```

```{r quantity infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 1

quantity.default <- sum(is.na(as.numeric(model.data$`Quantity Resource`)))

model.data$`Quantity Resource` <- ifelse(!is.na(as.numeric(model.data$`Quantity Resource`)),
                                    model.data$`Quantity Resource`,
                                    model.default)
```

```{r tank infill, warning=FALSE, echo=FALSE, message = FALSE}
# change 1:10 into bandings; 1:5, 6:8, 9:10 (from best to worst)
model.data$`Tank Condition Factor`[model.data$`Tank Condition Factor` %in% c(1:5)] <- 1
model.data$`Tank Condition Factor`[model.data$`Tank Condition Factor` %in% c(6:8)] <- 1.4
model.data$`Tank Condition Factor`[model.data$`Tank Condition Factor` %in% c(9:10)] <- 1.8

model.accepts <- c(1,1.4,1.8)
model.default <- 1

tank.default <- sum(!(model.data$`Tank Condition Factor` %in% model.accepts) | model.data$`Tank Condition Factor` == "Default")

model.data$`Tank Condition Factor` <- ifelse(model.data$`Tank Condition Factor` %in% model.accepts,
                                            model.data$`Tank Condition Factor`,
                                            model.default)
```

```{r coolers infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(1, 1.2, 1.4)
model.default <- 1

coolers.default <- sum(!(model.data$`Coolers_Radiator Condition Factor` %in% model.accepts) | model.data$`Coolers_Radiator Condition Factor` == "Default")

model.data$`Coolers_Radiator Condition Factor` <- ifelse(model.data$`Coolers_Radiator Condition Factor` %in% model.accepts,
                                            model.data$`Coolers_Radiator Condition Factor`,
                                            model.default)
```

```{r bushings infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(1, 1.2, 1.4)
model.default <- 1

bushings.default <- sum(!(model.data$`Bushings Condition Factor` %in% model.accepts) | model.data$`Bushings Condition Factor` == "Default")

model.data$`Bushings Condition Factor` <- ifelse(model.data$`Bushings Condition Factor` %in% model.accepts,
                                            model.data$`Bushings Condition Factor`,
                                            model.default)
```

```{r kiosk infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(1, 1.1, 1.2)
model.default <- 1

kiosk.default <- sum(!(model.data$`Kiosk Condition Factor` %in% model.accepts) | model.data$`Kiosk Condition Factor` == "Default")

model.data$`Kiosk Condition Factor` <- ifelse(model.data$`Kiosk Condition Factor` %in% model.accepts,
                                            model.data$`Kiosk Condition Factor`,
                                            model.default)
```

```{r cablebox infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(1, 1.1, 1.3)
model.default <- 1

cablebox.default <- sum(!(model.data$`Cablebox Condition Factor` %in% model.accepts) | model.data$`Cablebox Condition Factor` == "Default")

model.data$`Cablebox Condition Factor` <- ifelse(model.data$`Cablebox Condition Factor` %in% model.accepts,
                                            model.data$`Cablebox Condition Factor`,
                                            model.default)
```

```{r tx pd infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(1, 1.1, 1.3, 1.5)
model.default <- 1

tx.pd.default <- sum(!(model.data$`Partial Discharge Factor` %in% model.accepts) | model.data$`Partial Discharge Factor` == "Default")

model.data$`Partial Discharge Factor` <- ifelse(model.data$`Partial Discharge Factor` %in% model.accepts,
                                            model.data$`Partial Discharge Factor`,
                                            model.default)
```

```{r tc pd infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(1, 1.1, 1.3, 1.5)
model.default <- 1

tc.pd.default <- sum(!(model.data$`Tapchanger Partial Discharge Factor` %in% model.accepts) | model.data$`Tapchanger Partial Discharge Factor` == "Default")

model.data$`Tapchanger Partial Discharge Factor` <- ifelse(model.data$`Tapchanger Partial Discharge Factor` %in% model.accepts,
                                            model.data$`Tapchanger Partial Discharge Factor`,
                                            model.default)
```

```{r temp infill, warning=FALSE, echo=FALSE, message = FALSE}
# band temperature readings; 0:40, 41:60, 61:100 (best to worst) - NO LONGER NEEDED
model.data$`Temperature Readings Factor`[model.data$`Temperature Readings Factor` == "Normal"] <- 1
model.data$`Temperature Readings Factor`[model.data$`Temperature Readings Factor` == "Moderately High"] <- 1.2
model.data$`Temperature Readings Factor`[model.data$`Temperature Readings Factor` == "Very High"] <- 1.4

model.accepts <- c(1, 1.2, 1.4)
model.default <- 1

temp.default <- sum(!(model.data$`Temperature Readings Factor` %in% model.accepts) | model.data$`Temperature Readings Factor` == "Default")



model.data$`Temperature Readings Factor` <- ifelse(model.data$`Temperature Readings Factor` %in% model.accepts,
                                            model.data$`Temperature Readings Factor`,
                                            model.default)
```

```{r tx moisture, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

tx.moisture.default <- sum(is.na(as.numeric(model.data$Moisture)) | model.data$Moisture == "Default")

model.data$Moisture <- ifelse(!is.na(as.numeric(model.data$Moisture)),
                                    model.data$Moisture,
                                    model.default)
```

```{r tc moisture, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

tc.moisture.default <- sum(is.na(as.numeric(model.data$`Tapchanger Moisture`)) | model.data$`Tapchanger Moisture` == "Default")

model.data$`Tapchanger Moisture` <- ifelse(!is.na(as.numeric(model.data$`Tapchanger Moisture`)),
                                    model.data$`Tapchanger Moisture`,
                                    model.default)
```

```{r tx acidity, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

tx.acidity.default <- sum(is.na(as.numeric(model.data$`Oil Acidity`)) | model.data$`Oil Acidity` == "Default")

model.data$`Oil Acidity` <- ifelse(!is.na(as.numeric(model.data$`Oil Acidity`)),
                                    model.data$`Oil Acidity`,
                                    model.default)
```

```{r tc acidity, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

tc.acidity.default <- sum(is.na(as.numeric(model.data$`Tapchanger Oil Acidity`)) | model.data$`Tapchanger Oil Acidity` == "Default")

model.data$`Tapchanger Oil Acidity` <- ifelse(!is.na(as.numeric(model.data$`Tapchanger Oil Acidity`)),
                                    model.data$`Tapchanger Oil Acidity`,
                                    model.default)
```

```{r tx breakdown, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

tx.breakdown.default <- sum(is.na(as.numeric(model.data$`Breakdown Strength`)) | model.data$`Breakdown Strength` == "Default")

model.data$`Breakdown Strength` <- ifelse(!is.na(as.numeric(model.data$`Breakdown Strength`)),
                                    model.data$`Breakdown Strength`,
                                    model.default)
```

```{r tc breakdown, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

tc.breakdown.default <- sum(is.na(as.numeric(model.data$`Tapchanger Breakdown Strength`)) | model.data$`Tapchanger Breakdown Strength` == "Default")

model.data$`Tapchanger Breakdown Strength` <- ifelse(!is.na(as.numeric(model.data$`Tapchanger Breakdown Strength`)),
                                    model.data$`Tapchanger Breakdown Strength`,
                                    model.default)
```

```{r external cond, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(1, 1.4, 1.8)
model.default <- 1

external.cond.default <- sum(is.na(as.numeric(model.data$`Tapchanger External Condition Factor`)) | model.data$`Tapchanger External Condition Factor` == "Default")

model.data$`Tapchanger External Condition Factor` <- ifelse(!is.na(as.numeric(model.data$`Tapchanger External Condition Factor`)),
                                    model.data$`Tapchanger External Condition Factor`,
                                    model.default)
```

```{r internal cond, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(1, 1.2, 1.4)
model.default <- 1

internal.cond.default <- sum(is.na(as.numeric(model.data$`Tapchanger Internal Condition Factor`)) | model.data$`Tapchanger Internal Condition Factor` == "Default")

model.data$`Tapchanger Internal Condition Factor` <- ifelse(!is.na(as.numeric(model.data$`Tapchanger Internal Condition Factor`)),
                                    model.data$`Tapchanger Internal Condition Factor`,
                                    model.default)
```

```{r drive, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(0.9, 1, 1.2, 1.4)
model.default <- 1

drive.mech.default <- sum(is.na(as.numeric(model.data$`Tapchanger Drive Mechanism Condition Factor`)) | model.data$`Tapchanger Drive Mechanism Condition Factor` == "Default")

model.data$`Tapchanger Drive Mechanism Condition Factor` <- ifelse(!is.na(as.numeric(model.data$`Tapchanger Drive Mechanism Condition Factor`)),
                                    model.data$`Tapchanger Drive Mechanism Condition Factor`,
                                    model.default)
```


```{r contacts, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(0.95, 1, 1.1, 1.3)
model.default <- 1

contacts.default <- sum(is.na(as.numeric(model.data$`Tapchanger Selector_Divertor Contacts Factor`)) | model.data$`Tapchanger Selector_Divertor Contacts Factor` == "Default")

model.data$`Tapchanger Selector_Divertor Contacts Factor` <- ifelse(!is.na(as.numeric(model.data$`Tapchanger Selector_Divertor Contacts Factor`)),
                                    model.data$`Tapchanger Selector_Divertor Contacts Factor`,
                                    model.default)
```

```{r braids, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(0.95, 1, 1.05, 1.1)
model.default <- 1

braids.default <- sum(is.na(as.numeric(model.data$`Tapchanger Selector_Divertor Braids Factor`)) | model.data$`Tapchanger Selector_Divertor Braids Factor` == "Default")

model.data$`Tapchanger Selector_Divertor Braids Factor` <- ifelse(!is.na(as.numeric(model.data$`Tapchanger Selector_Divertor Braids Factor`)),
                                    model.data$`Tapchanger Selector_Divertor Braids Factor`,
                                    model.default)
```

```{r hydrogen1, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

hydrogen1.default <- sum(is.na(as.numeric(model.data$`Hydrogen`)) | model.data$Hydrogen == "Default")

model.data$`Hydrogen` <- ifelse(!is.na(as.numeric(model.data$`Hydrogen`)),
                                    model.data$`Hydrogen`,
                                    model.default)
```

```{r hydrogen2, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

hydrogen2.default <- sum(is.na(as.numeric(model.data$`2nd_Hydrogen`)) | model.data$`2nd_Hydrogen` == "Default")

model.data$`2nd_Hydrogen` <- ifelse(!is.na(as.numeric(model.data$`2nd_Hydrogen`)),
                                    model.data$`2nd_Hydrogen`,
                                    model.default)
```

```{r methane1, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

methane1.default <- sum(is.na(as.numeric(model.data$`Methane`)) | model.data$Methane == "Default")

model.data$`Methane` <- ifelse(!is.na(as.numeric(model.data$`Methane`)),
                                    model.data$`Methane`,
                                    model.default)
```

```{r methane2, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

methane2.default <- sum(is.na(as.numeric(model.data$`2nd_Methane`)) | model.data$`2nd_Methane` == "Default")

model.data$`2nd_Methane` <- ifelse(!is.na(as.numeric(model.data$`2nd_Methane`)),
                                    model.data$`2nd_Methane`,
                                    model.default)
```

```{r ethylene1, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

ethylene1.default <- sum(is.na(as.numeric(model.data$`Ethylene`)) | model.data$Ethylene == "Default")

model.data$`Ethylene` <- ifelse(!is.na(as.numeric(model.data$`Ethylene`)),
                                    model.data$`Ethylene`,
                                    model.default)
```

```{r ethylene2, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

ethylene2.default <- sum(is.na(as.numeric(model.data$`2nd_Ethylene`)) | model.data$`2nd_Ethylene` == "Default")

model.data$`2nd_Ethylene` <- ifelse(!is.na(as.numeric(model.data$`2nd_Ethylene`)),
                                    model.data$`2nd_Ethylene`,
                                    model.default)
```

```{r ethane1, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

ethane1.default <- sum(is.na(as.numeric(model.data$`Ethane`)) | model.data$Ethane == "Default")

model.data$`Ethane` <- ifelse(!is.na(as.numeric(model.data$`Ethane`)),
                                    model.data$`Ethane`,
                                    model.default)
```

```{r ethane2, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

ethane2.default <- sum(is.na(as.numeric(model.data$`2nd_Ethane`)) | model.data$`2nd_Ethane` == "Default")

model.data$`2nd_Ethane` <- ifelse(!is.na(as.numeric(model.data$`2nd_Ethane`)),
                                    model.data$`2nd_Ethane`,
                                    model.default)
```

```{r acetylene1, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

acetylene1.default <- sum(is.na(as.numeric(model.data$`Acetylene`)) | model.data$Acetylene == "Default")

model.data$`Acetylene` <- ifelse(!is.na(as.numeric(model.data$`Acetylene`)),
                                    model.data$`Acetylene`,
                                    model.default)
```

```{r acetylene2, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

acetylene2.default <- sum(is.na(as.numeric(model.data$`2nd_Acetylene`)) | model.data$`2nd_Acetylene` == "Default")

model.data$`2nd_Acetylene` <- ifelse(!is.na(as.numeric(model.data$`2nd_Acetylene`)),
                                    model.data$`2nd_Acetylene`,
                                    model.default)
```

```{r FFA, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- -1

ffa.default <- sum(is.na(as.numeric(model.data$FFA)) | model.data$FFA == "Default")

model.data$FFA <- ifelse(!is.na(as.numeric(model.data$FFA)),
                                    model.data$FFA,
                                    model.default)
```

```{r tx rel mod, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 1

tx.reliability.modifier.default <- sum(is.na(as.numeric(model.data$`Reliability Modifier`)))
tx.reliability.modifier.outside.range <- sum(model.data$`Reliability Modifier` < 0.6 | model.data$`Reliability Modifier` > 1.5)

model.data$`Reliability Modifier` <- pmin(pmax(model.data$`Reliability Modifier`, 0.6), 1.5)

model.data$`Reliability Modifier` <- ifelse(!is.na(as.numeric(model.data$`Reliability Modifier`)),
                                    model.data$`Reliability Modifier`,
                                    model.default)
```

```{r tx rel col, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 0.5

tx.reliability.collar.default <- sum(is.na(as.numeric(model.data$`Reliability Collar`)))

model.data$`Reliability Collar` <- ifelse(!is.na(as.numeric(model.data$`Reliability Collar`)),
                                    model.data$`Reliability Collar`,
                                    model.default)
```

```{r tc rel mod, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 1

tc.reliability.modifier.default <- sum(is.na(as.numeric(model.data$`Tapchanger Reliability Modifier`)))
tc.reliability.modifier.outside.range <- sum(model.data$`Tapchanger Reliability Modifier` < 0.6 | model.data$`Tapchanger Reliability Modifier` > 1.5)

model.data$`Tapchanger Reliability Modifier` <- pmin(pmax(model.data$`Tapchanger Reliability Modifier`, 0.6), 1.5)

model.data$`Tapchanger Reliability Modifier` <- ifelse(!is.na(as.numeric(model.data$`Tapchanger Reliability Modifier`)),
                                    model.data$`Tapchanger Reliability Modifier`,
                                    model.default)
```

```{r tc rel col, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 0.5

tc.reliability.collar.default <- sum(is.na(as.numeric(model.data$`Tapchanger Reliability Collar`)))

model.data$`Tapchanger Reliability Collar` <- ifelse(!is.na(as.numeric(model.data$`Tapchanger Reliability Collar`)),
                                    model.data$`Tapchanger Reliability Collar`,
                                    model.default)
```

## Default Counts

Any fields which are infilled during the process are assessed for default values below. Additionally, `r tx.reliability.modifier.outside.range` transformers and `r tc.reliability.modifier.outside.range` tapchangers are outside the required range of 0.6 to 1.5.

```{r summary, warning=FALSE, echo=FALSE, message = FALSE}
columns.infilled <- unique(names(model.data))[!(unique(names(model.data)) %in% c("Area1", "Type", "N1_Group", "Asset_Number", "Driftsmrk","X","Y"))]

infilling.summary <- data.frame(`Model Name` = columns.infilled,
                                `Asset Count Default` = c(manufacturer.default,
                                                          relation.default,
                                                          code.default,
                                                          health.category.default,
                                                          asset.category.default,
                                                          subdivision.default,
                                                          voltage.default,
                                                          tx.year.default,
                                                          tc.year.default,
                                                          tx.coast.default,
                                                          tc.coast.default,
                                                          tx.altitude.default,
                                                          tx.corrosion.default,
                                                          tx.distance.default,
                                                          tc.altitude.default,
                                                          tc.corrosion.default,
                                                          tc.distance.default,
                                                          tx.position.default,
                                                          tc.position.default,
                                                          tx.duty.default,
                                                          tc.duty.default,
                                                          customers.default,
                                                          top.30.default,
                                                          type.financial.default,
                                                          tx.type.default,
                                                          tc.type.default,
                                                          access.financial.default,
                                                          location.safety.default,
                                                          type.safety.default,
                                                          size.environmental.default,
                                                          proximity.default,
                                                          bunding.default,
                                                          actual.load.default,
                                                          network.default,
                                                          quantity.default,
                                                          tank.default,
                                                          coolers.default,
                                                          bushings.default,
                                                          kiosk.default,
                                                          cablebox.default,
                                                          external.cond.default,
                                                          internal.cond.default,
                                                          drive.mech.default,
                                                          contacts.default,
                                                          braids.default,
                                                          tx.pd.default,
                                                          temp.default,
                                                          tc.pd.default,
                                                          tx.acidity.default,
                                                          tx.moisture.default,
                                                          tx.breakdown.default,
                                                          tc.acidity.default,
                                                          tc.moisture.default,
                                                          tc.breakdown.default,
                                                          hydrogen1.default,
                                                          methane1.default,
                                                          ethylene1.default,
                                                          ethane1.default,
                                                          acetylene1.default,
                                                          hydrogen2.default,
                                                          methane2.default,
                                                          ethylene2.default,
                                                          ethane2.default,
                                                          acetylene2.default,
                                                          ffa.default,
                                                          tx.reliability.modifier.default,
                                                          tx.reliability.collar.default,
                                                          tc.reliability.modifier.default,
                                                          tc.reliability.collar.default), check.names = F)

kable(infilling.summary, "html") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"))
```

```{r GIS input csv, warning=FALSE, echo=FALSE, message = FALSE, include = FALSE}
shape.file <- data.table(assets)

shape.file <- shape.file[!is.na(as.numeric(shape.file$X)) & !is.na(as.numeric(shape.file$Y))]

shape.file[, wkt_raw := paste0("POINT (", shape.file$X, " ", shape.file$Y, ")")]

shape.file <- st_as_sf(shape.file, wkt = "wkt_raw")



# Shape file must be in WGS84 projection for Qlik. EPSG code 4326
st_crs(shape.file) <- 25832
st_crs(shape.file)

# Set projection to WGS84
shape.file <- st_transform(shape.file, crs = 4326)

# Shape file must not have a z dimension to the geometry
# Remove z dimension
shape.file <- st_zm(shape.file)

# Use sf function to add new column with WKT (well-known text) geometry
shape.file.wkt <- shape.file %>%
  mutate(wkt_transformed = st_as_text(shape.file$wkt_raw))

# Use QlikLineFormat function to convert the WKT to format required by Qlik.
data.for.qlik <- shape.file.wkt %>%
  mutate(qlikpoint = QlikLineFormat(wkt_transformed))

# Remove shape file geometry and WKT
st_geometry(data.for.qlik) <- NULL
data.for.qlik$wkt_raw <- NULL
data.for.qlik$wkt_transformed <- NULL

gis.data.for.qlik <- strsplit(data.for.qlik$qlikpoint, ",")
gis.data.for.qlik.x <- unlist(lapply(gis.data.for.qlik, function(x) gsub("\\[", "", x[1])))
gis.data.for.qlik.y <- unlist(lapply(gis.data.for.qlik, function(x) gsub("\\]", "", x[2])))

data.for.qlik <- data.table(data.for.qlik)

data.for.qlik <- data.for.qlik[, .(AssetID = Asset_Number,DRFTMRK = Code, X = gis.data.for.qlik.x, Y = gis.data.for.qlik.y)]

# Write csv of data for import to Qlik
write_csv(data.for.qlik, args[5]) ## this needs to be an extra output from the 
                                                                                                  ## R script and should be the following:
                                                                                                  ## Asset_Number, X, Y and Driftsmrk



```



```{r export, warning=FALSE, echo=FALSE, message = FALSE}

write_csv(model.data, args[4])

```