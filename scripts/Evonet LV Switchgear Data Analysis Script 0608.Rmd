---
title: "Evonet LV Switchgear and Other Data Analysis"
output:
  html_document:
    number_sections: yes
    theme: yeti
    toc: yes
    toc_float: yes
---

```{r headers, message=FALSE, warning=FALSE, echo=FALSE, results='hide'}
#BeginHeader
#Input#DataTable#Name:LV Switchgear and Other Asset Base#Description:LV Switchgear and Other raw asset data.
#Output#DataTable#Name:Switchgear Distribution Population Summary#Description:Summary of population for each field of the data.
#Output#DataTable#Name:LV Switchgear and Other For Model#Description:LV Switchgear and Other asset base for the model.
#Output#DataTable#Name:LV Switchgear and Other GIS#Description:LV Switchgear and Other GIS.
#EndHeader

EDA <- F # set to TRUE if running in EDA data labs

if (EDA) {
  args <- commandArgs(trailingOnly = TRUE)
} else {
  args <- c(getwd(),
            "Data/Asset Bases/LV Switchgear Raw Assets2 v1 0608.csv",
            "Output Data/LV Switchgear and Other Population Summary 0608.csv",
            "Output Data/LV Switchgear and Other For Model 0608.csv", 
            "Output Data/LV Switchgear and Other GIS 0608.csv")
}

setwd(args[1])
```


```{r message=FALSE, echo=FALSE, warning=FALSE}
library(tidyverse)
library(data.table)
library(ggplot2)
library(DescTools)
library(knitr)
library(kableExtra)
library(stringi)
library(sf)
library(stringr)

sg.assets <- data.table(read_csv(args[2], locale=locale(encoding="Latin1")))

## remove any completely empty rows and make asset id unique throughout
sg.assets <- sg.assets[!apply(is.na(sg.assets) | sg.assets == "", 1, all),]
sg.assets$Asset_Number <- make.unique(as.character(sg.assets$Asset_Number))

Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}

# calculate average year of manufacture (excluding 0, NA & default values)
sg.assets.copy <- sg.assets
sg.assets.copy$Year_Of_Manufacture[sg.assets.copy$Year_Of_Manufacture==0] <- NA
average.year <- round(mean(as.numeric(sg.assets.copy$Year_Of_Manufacture), na.rm=T))

##Strip out danish characters to limit problems.
#ae
sg.assets <- sg.assets[, lapply(.SD,   function(x){gsub("Æ", "AE", gsub("æ", "ae", x))}),  .SDcols = 1:ncol(sg.assets)]
names(sg.assets) <- gsub("Æ", "AE", gsub("æ", "ae", names(sg.assets)))

#aa
sg.assets <- sg.assets[, lapply(.SD,   function(x){gsub("Å", "AA", gsub("å", "aa", x))}),  .SDcols = 1:ncol(sg.assets)]
names(sg.assets) <- gsub("Å", "AA", gsub("å", "aa", names(sg.assets)))

#oe
sg.assets <- sg.assets[, lapply(.SD,   function(x){gsub("Ø", "OE", gsub("ø", "oe", x))}),  .SDcols = 1:ncol(sg.assets)]
names(sg.assets) <- gsub("Ø", "OE", gsub("ø", "oe", names(sg.assets)))

sg.assets <- as.tibble(sg.assets)

# define model field names
# model.names <- c("Area1", "Type", "Asset_Number", "Health_Index_Asset_Category", "SubDivision",
#                  "Asset_Register_Category", "Replaced_Moving_Portion", "Coast_side",
#                  "Voltage", "Year_Of_Manufacture", "Altitude", "Corrosion_Index",
#                  "Distance_From_Coast", "Position", "Duty_Factor", "Access_Financial_Factor",
#                  "Connected_Customers", "Customer_Sensitivity_Factor", "KVA_Band_Per_Customer",
#                  "Location_Safety_Factor", "Type_Safety_Factor", "Type_Financial_Factor",
#                  "Proximity", "Bunding_Factor", "DRFTMRK", "MRK_U", "Type_Factor",
#                  "Top_30_Customers_Factor", "TOP30",
#                  "Quantity Resource", "External Condition Factor", "Compound Leaks Factor",
#                  "Internal Condition Factor", "Insulation Factor",
#                  "Signs of Heating Factor", "Phase Barriers Factor",
#                  "Operational Adequacy Factor", "Security Factor",
#                  "Reliability Modifier", "Reliability Collar")
# sg.assets.copy <- sg.assets.copy[, names(sg.assets.copy) %in% model.names]
```

# **Asset Quantity**

There are **`r nrow(sg.assets)`** records in the source data. Ignoring NA or default values:

* The average year of manufacture is **`r average.year`**.

---

# **Population Summary**

The chart below shows the fields provided in each source data item and indicates how populated each field is. An entry is deemed as unpopulated if it is either NA or blank.

```{r warning=FALSE, echo=FALSE, message = FALSE, fig.height = 18}
sg.assets[sg.assets == ""] <-  NA
Unpopulated <- apply(sg.assets, 2, function(x) (mean(is.na(x)))*100)
Default <- apply(sg.assets, 2, function(x) (mean(x %in% c("Default", "default", "DEFAULT")))*100)
Default <- ifelse(is.na(Default), 0, Default)
Populated <- 100 - Unpopulated - Default
Field <- names(Unpopulated)
data.pop <- data.frame(Field, Unpopulated, Populated, Default)
data.pop <- gather(data.pop, variable, value, -Field) %>%
  mutate(variable = factor(variable, levels = c("Unpopulated", "Populated", "Default"), ordered = TRUE)) 

write_csv(data.pop, args[3])

# repeat for copy so that it works with ggplot2
sg.assets.copy[sg.assets.copy == ""] <-  NA
Unpopulated <- apply(sg.assets.copy, 2, function(x) (mean(is.na(x)))*100)
Default <- apply(sg.assets.copy, 2, function(x) (mean(x %in% c("Default", "default", "DEFAULT")))*100)
Default <- ifelse(is.na(Default), 0, Default)
Populated <- 100 - Unpopulated - Default
Field <- names(Unpopulated)
data.pop <- data.frame(Field, Unpopulated, Populated, Default)
data.pop <- gather(data.pop, variable, value, -Field) %>%
  mutate(variable = factor(variable, levels = c("Unpopulated", "Populated", "Default"), ordered = TRUE)) 

ggplot(data = data.pop, aes(x = Field, y = value, fill = variable)) + 
    geom_bar(stat = "identity") + coord_flip() +
  labs(main = "Percentage Population", y="Percentage", fill="Population Levels")
```



```{r GIS, message=FALSE, warning=FALSE, echo=FALSE}


# Function to make Qlik map line format from WKT geometry -----------------


QlikLineFormat <- function(wkt) {
 # Converts WKT (well-known text) line geometry to the format required by Qlik
 #
 # Args:
 #   wkt: Character vector of 2d line geometry in WKT format
 #
 # Returns:
 #   A character vector of same length as wkt containing line geometry in format
 #   which can be visualised by Qlik.
  
  # Remove unrequired text from wkt
  qlik.line <- str_replace(wkt, "POINT ", "")
  qlik.line <- str_replace(qlik.line, "\\(", "")
  qlik.line <- str_replace(qlik.line, "\\)", "")
  # Split into list based on comma seperated values
  qlik.line <- str_split(qlik.line, ",")
  
  # Inner function to add markup to each item in the list
  sq.brackets <- function(x) {
    x <- str_replace(x, "^ ", "")
    x <- str_replace(x, " ", ",")
    x <- paste0("[", x, "]")
    x <- str_flatten(x, collapse = ",")
  }
  
  # Apply Qlik markup to wkt
  qlik.line <- lapply(qlik.line, sq.brackets)
  # Convert list to vector
  qlik.line <- unlist(qlik.line)
  
  return(qlik.line)
}

str_flatten <- function(string, collapse = "") {
  stri_flatten(string, collapse = collapse)
}

```

## Asset ID

Asset_Number is the unique identifier. There is a total of **`r length(sg.assets$Asset_Number)`** rows in the switchgear source data. There are **`r length(unique(sg.assets$Asset_Number))`** unique values for Asset_Number.

## Corrosion

```{r corrosion, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(factor(Corrosion_Index))) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Corrosion Category", y="Count", x="Corrosion Index")

```

## Distance from Coast

```{r dist.from.coast, message=FALSE, warning=FALSE, echo=FALSE}
PlotFdist(as.numeric(sg.assets$Distance_From_Coast), na.rm = TRUE,
          main = "Distribution of LV Switchgear by Distance From Coast")
```

## Indoor/Outdoor

```{r indoor.outdoor, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(Position)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Indoor/Outdoor (OD=Outdoor, ID=Indoor)", y="Count", x="Position")
```

## Year Of Manufacture

```{r age, message=FALSE, warning=FALSE, echo=FALSE}
PlotFdist(as.integer(sg.assets$Year_Of_Manufacture), na.rm = TRUE,
          main = "Distribution of LV Switchgear by Year Of Manufacture")
```

## External Condition

```{r ext cond, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(`External Condition Factor`)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by External Condition", y="Count", x="External Condition")
```

## Internal Condition

```{r int cond, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(`Internal Condition Factor`)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Internal Condition", y="Count", x="Internal Condition")
```

## Compound Leaks

```{r oil leaks gas pressure, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(`Compound Leaks Factor`)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Compound Leaks", y="Count", x="Compound Leaks")
```

## Insulation

```{r thermo assessment, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(`Insulation Factor`)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Insulation", y="Count", x="Insulation")
```

## Signs of Heating

```{r indoor env cond, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(`Signs of Heating Factor`)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Signs of Heating Condition", y="Count", x="Signs of Heating")
```

## Phase Barriers

```{r pd, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(`Phase Barriers Factor`)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Phase Barriers", y="Count", x="Phase Barriers")
```

## Operational Adequacy

```{r ductor test, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(`Operational Adequacy Factor`)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Operational Adequacy", y="Count", x="Operational Adequacy")
```

## Security

```{r oil tests gas tests, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(`Security Factor`)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Security", y="Count", x="Security")
```

## Reliability Modifier

```{r rel mod, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(`Reliability Modifier`)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Reliability Modifier", y="Count", x="Reliability Modifier")
```

## Reliability Collar

```{r rel col, message=FALSE, warning=FALSE, echo=FALSE}
ggplot(sg.assets, aes(`Reliability Collar`)) +
  geom_bar() +
  labs(title="Count of LV Switchgear by Reliability Collar", y="Count", x="Reliability Collar")
```

---

# **Creation of Model Asset Base**

```{r model, warning=FALSE, echo=FALSE, message = FALSE}
assets <- sg.assets

raw.model.data <- data.table(Area1 = "Evonet",
                          Type = "Switchgear",
                          Asset_Number = assets$Asset_Number,
                          DRFTMRK = assets$DRFTMRK,
                          Coast_Side= "Default",
                          Evonet_Group = "10/0.4kV Station",
                          Health_Index_Asset_Category = assets$Health_Index_Asset_Category,
                          Asset_Register_Category = assets$Asset_Register_Category,
                          Voltage = "LV",
                          Year_Of_Manufacture = assets$Year_Of_Manufacture,
                          Altitude = assets$Altitude,
                          Corrosion_Index = assets$Corrosion_Index,
                          Distance_From_Coast = assets$Distance_From_Coast,
                          Position = assets$Position,
                          Access_Financial_Factor = assets$Access_Financial_Factor,
                          Location_Safety_Factor = assets$Location_Safety_Factor,
                          Type_Safety_Factor = assets$Type_Safety_Factor,
                          Type_Financial_Factor = assets$Type_Financial_Factor,
                          Number_Of_Customers = assets$Connected_Customers,
                          Customer_Sensitivity_Factor = assets$Customer_Sensitivity_Factor,
                          KVA_Band_Per_Customer = assets$KVA_Band_Per_Customer,
                          Type_Factor = "Default",
                          Top_30_Customers_Factor = assets$TOP30,
                          `Quantity Resource` = assets$`Quantity Resource`,
                          `External Condition Factor` = assets$`External Condition Factor`,
                          `Internal Condition Factor` = assets$`Internal Condition Factor`,
                          `Compound Leaks Factor` = assets$`Compound Leaks Factor`,
                          `Insulation Factor` = assets$`Insulation Factor`,
                          `Signs of Heating Factor` = assets$`Signs of Heating Factor`,
                          `Phase Barriers Factor` = assets$`Phase Barriers Factor`,
                          `Operational Adequacy Factor` = assets$`Operational Adequacy Factor`,
                          `Security Factor` = assets$`Security Factor`,
                          `Reliability Modifier` = assets$`Reliability Modifier`,	
                          `Reliability Collar` = assets$`Reliability Collar`,
check.names = F, stringsAsFactors = F)
                          
table.data <- data.frame(`Model Field Name` = colnames(raw.model.data),
                         `Data Used` = c("'Evonet' for all assets",
                                         "'Switchgear' for all assets",
                                         "Asset_Number",
                                         "DRFTMRK",
                                         "'Default' for all assets",
                                         "10/0.4kV Station",
                                         "Health_Index_Asset_Category",
                                         "Asset_Register_Category",
                                         "'LV' for all assets",
                                         "Year_Of_Manufacture",
                                         "Altitude",
                                         "Corrosion_Index",
                                         "Distance_From_Coast",
                                         "Position",
                                         "Access_Financial_Factor",
                                         "Location_Safety_Factor",
                                         "Type_Safety_Factor",
                                         "Type_Financial_Factor",
                                         "Connected_Customers",
                                         "Customer_Sensitivity_Factor",
                                         "KVA_Band_Per_Customer",
                                         "'Default' for all assets",
                                         "TOP30",
                                         "Quantity Resource",
                                         "External Condition Factor",
                                         "Internal Condition Factor",
                                         "Compound Leaks Factor",
                                         "Insulation Factor",
                                         "Signs of Heating Factor",
                                         "Phase Barriers Factor",
                                         "Operational Adequacy Factor",
                                         "Security Factor",
                                         "Reliability Modifier",	
                                         "Reliability Collar"), check.names = F)

kable(table.data, "html") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"))

model.data <- raw.model.data
```

```{r coast side infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("East", "West")
model.default <- "East"

coast.side.default <- sum(!(model.data$Coast_Side %in% model.accepts))

model.data$Coast_Side <- ifelse(model.data$Coast_Side %in% model.accepts,
                                    model.data$Coast_Side,
                                    model.default)
```

```{r health category infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- "LV Switchgear and Other"
model.default <- "LV Switchgear and Other"

health.category.default <- sum(!(model.data$Health_Index_Asset_Category %in% model.accepts))

model.data$Health_Index_Asset_Category <- ifelse(model.data$Health_Index_Asset_Category %in% model.accepts,
                                    model.data$Health_Index_Asset_Category,
                                    model.default)
```

```{r asset category infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("LV Circuit Breaker", "LV Board (WM)", "LV Board (X-type Network) (WM)",
                   "LV Pillar (ID)", "LV Pillar (OD at Substation)",
                   "LV Pillar (OD not at a Substation)")
model.default <- "LV Board (WM)"

asset.category.default <- sum(!(model.data$Asset_Register_Category %in% model.accepts))

model.data$Asset_Register_Category <- ifelse(model.data$Asset_Register_Category %in% model.accepts,
                                    model.data$Asset_Register_Category,
                                    model.default)
```

```{r voltage infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <-c("LV")
model.default <- "LV"

voltage.default <- sum(!(model.data$Voltage %in% model.accepts))

model.data$Voltage <- ifelse(model.data$Voltage %in% model.accepts,
                                    model.data$Voltage,
                                    model.default)
```

```{r year infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default" # model cannot run with this! Will need a default - done below

year.default <- sum(is.na(as.numeric(model.data$Year_Of_Manufacture)))

# change NA year values to average across asset base; 0 is used as a default value, so change this to NA
model.data$Year_Of_Manufacture[model.data$Year_Of_Manufacture==0] <- NA
model.data$Year_Of_Manufacture <- as.numeric(model.data$Year_Of_Manufacture)
model.data$Year_Of_Manufacture[is.na(model.data$Year_Of_Manufacture)] <- round(mean(model.data$Year_Of_Manufacture, na.rm=T))

model.data$Year_Of_Manufacture <- ifelse(!is.na(as.numeric(model.data$Year_Of_Manufacture)),
                                    model.data$Year_Of_Manufacture,
                                    model.default)
```

```{r altitude infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

model.data$Altitude <- as.numeric(gsub("([^\\d])", "", model.data$Altitude, perl=TRUE))

altitude.default <- sum(is.na(as.numeric(model.data$Altitude)) | model.data$Altitude=="Default")

model.data$Altitude <- ifelse(!is.na(as.numeric(model.data$Altitude)),
                                    model.data$Altitude,
                                    model.default)
```

```{r corrosion infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- 1:5
model.default <- "Default"

corrosion.default <- sum(!(model.data$Corrosion_Index %in% model.accepts))

model.data$Corrosion_Index <- ifelse(model.data$Corrosion_Index %in% model.accepts,
                                    model.data$Corrosion_Index,
                                    model.default)
```

```{r distance infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- "Default"

distance.default <- sum(is.na(as.numeric(model.data$Distance_From_Coast)))

model.data$Distance_From_Coast <- ifelse(!is.na(as.numeric(model.data$Distance_From_Coast)),
                                    model.data$Distance_From_Coast,
                                    model.default)
```

```{r position infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("ID", "OD")
model.default <- "ID"

model.data$Position[model.data$Position %in% c("indoors", "Indoors")] <- "ID"
model.data$Position[model.data$Position %in% c("outdoors", "Outdoors")] <- "OD"

position.default <- sum(!(model.data$Position %in% model.accepts))

model.data$Position <- ifelse(model.data$Position %in% model.accepts,
                                    model.data$Position,
                                    model.default)
```

```{r access financial infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("A", "B", "C")
model.default <- "A"

access.financial.default <- sum(!(model.data$Access_Financial_Factor %in% model.accepts))

model.data$Access_Financial_Factor <- ifelse(model.data$Access_Financial_Factor %in% model.accepts,
                                    model.data$Access_Financial_Factor,
                                    model.default)
```

```{r loc safety infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("High", "Medium", "Low")
model.default <- "Medium"

model.data$Location_Safety_Factor[model.data$Location_Safety_Factor=="low"] <- "Low"
model.data$Location_Safety_Factor[model.data$Location_Safety_Factor=="medium"] <- "Medium"
model.data$Location_Safety_Factor[model.data$Location_Safety_Factor=="high"] <- "High"

location.safety.default <- sum(!(model.data$Location_Safety_Factor %in% model.accepts))

model.data$Location_Safety_Factor <- ifelse(model.data$Location_Safety_Factor %in% model.accepts,
                                    model.data$Location_Safety_Factor,
                                    model.default)
```

```{r type safety infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("High", "Medium", "Low")
model.default <- "Medium"

model.data$Type_Safety_Factor[model.data$Type_Safety_Factor=="low"] <- "Low"
model.data$Type_Safety_Factor[model.data$Type_Safety_Factor=="medium"] <- "Medium"
model.data$Type_Safety_Factor[model.data$Type_Safety_Factor=="high"] <- "High"

type.safety.default <- sum(!(model.data$Type_Safety_Factor %in% model.accepts))

model.data$Type_Safety_Factor <- ifelse(model.data$Type_Safety_Factor %in% model.accepts,
                                    model.data$Type_Safety_Factor,
                                    model.default)
```

```{r type financial infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("Non Asbestos clad", "Asbestos clad")
model.default <- "Non Asbestos clad"

type.fin.default <- sum(!(model.data$Type_Financial_Factor %in% model.accepts))

model.data$Type_Financial_Factor <- ifelse(model.data$Type_Financial_Factor %in% model.accepts,
                                    model.data$Type_Financial_Factor,
                                    model.default)
```

```{r connected customers infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- mean(as.numeric(model.data$Number_Of_Customers), na.rm = T)
model.default <- ifelse(!is.na(model.default), model.default, 200)

connected.customers.default <- sum(is.na(as.numeric(model.data$Number_Of_Customers)))

model.data$Number_Of_Customers <- ifelse(!(is.na(as.numeric(model.data$Number_Of_Customers))),
                                    model.data$Number_Of_Customers,
                                    model.default)
```

```{r customer sensitivity infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- seq(1, 2, by=0.001)
model.default <- 1

customer.sensitivity.default <- sum(!(model.data$Customer_Sensitivity_Factor %in% model.accepts))

model.data$Customer_Sensitivity_Factor <- ifelse(model.data$Customer_Sensitivity_Factor %in% model.accepts,
                                    model.data$Customer_Sensitivity_Factor,
                                    model.default)
```

```{r kva band infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c("<50", ">=50 and <100", ">=100 and <500", ">=500 and <1000", ">=1000 and <2000",
                   ">=2000")
model.default <- "<50"

model.data$KVA_Band_Per_Customer <- gsub(" ", "", model.data$KVA_Band_Per_Customer)
model.data$KVA_Band_Per_Customer <- gsub("and", " and ", model.data$KVA_Band_Per_Customer)

kva.default <- sum(!(model.data$KVA_Band_Per_Customer %in% model.accepts))

model.data$KVA_Band_Per_Customer <- ifelse(model.data$KVA_Band_Per_Customer %in% model.accepts,
                                    model.data$KVA_Band_Per_Customer,
                                    model.default)
```

```{r top 30 customers infill, warning=FALSE, echo=FALSE, message = FALSE}
model.accepts <- c(1, 3)
model.default <- 1

top.30.customers.default <- sum(!(as.numeric(model.data$Top_30_Customers_Factor) %in% model.accepts))

model.data$Top_30_Customers_Factor <- ifelse(as.numeric(model.data$Top_30_Customers_Factor) %in% model.accepts,
                                    model.data$Top_30_Customers_Factor,
                                    model.default)
```

```{r quantity infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 1

quantity.default <- sum(is.na(as.numeric(model.data$`Quantity Resource`)))

model.data$`Quantity Resource` <- ifelse(!is.na(as.numeric(model.data$`Quantity Resource`)),
                                    model.data$`Quantity Resource`,
                                    model.default)
```

```{r external cond infill, warning=FALSE, echo=FALSE, message = FALSE}
model.data$`External Condition Factor` <- gsub("\\n", "", model.data$`External Condition Factor`)
model.data$`External Condition Factor` <- toupper(model.data$`External Condition Factor`)
model.data$`External Condition Factor`[model.data$`External Condition Factor` %in% c("AS NEW")] <- 0.9
model.data$`External Condition Factor`[model.data$`External Condition Factor` %in% c("NORMAL WEAR")] <- 1
model.data$`External Condition Factor`[model.data$`External Condition Factor` %in% c("SOME DETERIORATION", "SOME DETERIORIATION")] <- 1.2
model.data$`External Condition Factor`[model.data$`External Condition Factor` %in% c("SUBSTANTIAL DETERIORATION", "SUBSTIANTIAL DETERIORIATION", "SUBSTIANTIAL DETERIORATION")] <- 1.4

model.accepts <- c(0.9, 1, 1.2, 1.4)
model.default <- 1

external.cond.default <- sum(!(model.data$`External Condition Factor` %in% model.accepts) | model.data$`External Condition Factor` == "DEFAULT")

model.data$`External Condition Factor` <- ifelse(model.data$`External Condition Factor` %in% model.accepts,
                                            model.data$`External Condition Factor`,
                                            model.default)
```

```{r internal cond infill, warning=FALSE, echo=FALSE, message = FALSE}
model.data$`Internal Condition Factor` <- gsub("\\n", "", model.data$`Internal Condition Factor`)
model.data$`Internal Condition Factor` <- toupper(model.data$`Internal Condition Factor`)
model.data$`Internal Condition Factor`[model.data$`Internal Condition Factor` %in% c("AS NEW")] <- 0.9
model.data$`Internal Condition Factor`[model.data$`Internal Condition Factor` %in% c("NORMAL WEAR")] <- 1
model.data$`Internal Condition Factor`[model.data$`Internal Condition Factor` %in% c("SOME DETERIORATION", "SOME DETERIORIATION")] <- 1.2
model.data$`Internal Condition Factor`[model.data$`Internal Condition Factor` %in% c("SUBSTANTIAL DETERIORATION", "SUBSTANTIAL DETERIORIATION", "SUBSTIANTIAL DETERIORATION")] <- 1.4

model.accepts <- c(0.9, 1, 1.2, 1.4)
model.default <- 1

internal.cond.default <- sum(!(model.data$`Internal Condition Factor` %in% model.accepts) | model.data$`Internal Condition Factor` == "DEFAULT")

model.data$`Internal Condition Factor` <- ifelse(model.data$`Internal Condition Factor` %in% model.accepts,
                                            model.data$`Internal Condition Factor`,
                                            model.default)
```

```{r compound leaks infill, warning=FALSE, echo=FALSE, message = FALSE}
model.data$`Compound Leaks Factor` <- gsub("\\n", "", model.data$`Compound Leaks Factor`)
model.data$`Compound Leaks Factor` <- toupper(model.data$`Compound Leaks Factor`)
model.data$`Compound Leaks Factor`[model.data$`Compound Leaks Factor` %in% c("GOOD")] <- 0.9
model.data$`Compound Leaks Factor`[model.data$`Compound Leaks Factor` %in% c("POOR")] <- 1
model.data$`Compound Leaks Factor`[model.data$`Compound Leaks Factor` %in% c("SLIGHT LEAK")] <- 1.1

model.accepts <- c(0.9, 1, 1.1)
model.default <- 1

compound.leaks.default <- sum(!(model.data$`Compound Leaks Factor` %in% model.accepts) | model.data$`Compound Leaks Factor` == "DEFAULT")

model.data$`Compound Leaks Factor` <- ifelse(model.data$`Compound Leaks Factor` %in% model.accepts,
                                            model.data$`Compound Leaks Factor`,
                                            model.default)
```

```{r insulation infill, warning=FALSE, echo=FALSE, message = FALSE}
model.data$`Insulation Factor` <- gsub("\\n", "", model.data$`Insulation Factor`)
model.data$`Insulation Factor` <- toupper(model.data$`Insulation Factor`)
model.data$`Insulation Factor`[model.data$`Insulation Factor` %in% c("SATISFACTORY")] <- 0.9
model.data$`Insulation Factor`[model.data$`Insulation Factor` %in% c("SOME DETERIORATION")] <- 1
model.data$`Insulation Factor`[model.data$`Insulation Factor` %in% c("SUBSTANTIAL DETERIORATION")] <- 1.3

model.accepts <- c(0.9, 1, 1.3)
model.default <- 1

insulation.default <- sum(!(model.data$`Insulation Factor` %in% model.accepts) | model.data$`Insulation Factor` == "DEFAULT")

model.data$`Insulation Factor` <- ifelse(model.data$`Insulation Factor` %in% model.accepts,
                                            model.data$`Insulation Factor`,
                                            model.default)
```

```{r signs of heating infill, warning=FALSE, echo=FALSE, message = FALSE}
model.data$`Signs of Heating Factor` <- gsub("\\n", "", model.data$`Signs of Heating Factor`)
model.data$`Signs of Heating Factor` <- toupper(model.data$`Signs of Heating Factor`)
model.data$`Signs of Heating Factor`[model.data$`Signs of Heating Factor` %in% c("NO DETERIORATION")] <- 1
model.data$`Signs of Heating Factor`[model.data$`Signs of Heating Factor` %in% c("MINOR DETERIORATION")] <- 1.2
model.data$`Signs of Heating Factor`[model.data$`Signs of Heating Factor` %in% c("MAJOR DETERIORATION")] <- 1.5

model.accepts <- c(1, 1.2, 1.5)
model.default <- 1

signs.of.heating.default <- sum(!(model.data$`Signs of Heating Factor` %in% model.accepts) | model.data$`Signs of Heating Factor` == "DEFAULT")

model.data$`Signs of Heating Factor` <- ifelse(model.data$`Signs of Heating Factor` %in% model.accepts,
                                            model.data$`Signs of Heating Factor`,
                                            model.default)
```

```{r phase barriers infill, warning=FALSE, echo=FALSE, message = FALSE}
model.data$`Phase Barriers Factor` <- gsub("\\n", "", model.data$`Phase Barriers Factor`)
model.data$`Phase Barriers Factor` <- toupper(model.data$`Phase Barriers Factor`)
model.data$`Phase Barriers Factor`[model.data$`Phase Barriers Factor` %in% c("YES")] <- 1
model.data$`Phase Barriers Factor`[model.data$`Phase Barriers Factor` %in% c("MISSING")] <- 1.3

model.accepts <- c(1, 1.3)
model.default <- 1

phase.barriers.default <- sum(!(model.data$`Phase Barriers Factor` %in% model.accepts) | model.data$`Phase Barriers Factor` == "Default")

model.data$`Phase Barriers Factor` <- ifelse(model.data$`Phase Barriers Factor` %in% model.accepts,
                                            model.data$`Phase Barriers Factor`,
                                            model.default)
```

```{r operation ad infill, warning=FALSE, echo=FALSE, message = FALSE}
model.data$`Operational Adequacy Factor` <- gsub("\\n", "", model.data$`Operational Adequacy Factor`)
model.data$`Operational Adequacy Factor` <- toupper(model.data$`Operational Adequacy Factor`)
## LV Circuit Breaker
model.data$`Operational Adequacy Factor`[(model.data$Asset_Register_Category=="LV Circuit Breaker") && (model.data$`Operational Adequacy Factor` %in% c("ACCEPTABLE"))] <- 1
model.data$`Operational Adequacy Factor`[(model.data$Asset_Register_Category=="LV Circuit Breaker") && (model.data$`Operational Adequacy Factor` %in% c("UNACCEPTABLE"))] <- 1.6
## LV Board (VM)
model.data$`Operational Adequacy Factor`[(model.data$Asset_Register_Category=="LV Board (WM)") && (model.data$`Operational Adequacy Factor` %in% c("OPERABLE"))] <- 1
model.data$`Operational Adequacy Factor`[(model.data$Asset_Register_Category=="LV Board (WM)") && (model.data$`Operational Adequacy Factor` %in% c("INOPERABLE - SECURE"))] <- 1.3
model.data$`Operational Adequacy Factor`[(model.data$Asset_Register_Category=="LV Board (WM)") && (model.data$`Operational Adequacy Factor` %in% c("INOPERABLE - HAZARDOUS"))] <- 1.5
## LV UGB
model.data$`Operational Adequacy Factor`[(model.data$Asset_Register_Category=="LV UGB") && (model.data$`Operational Adequacy Factor` %in% c("OPERABLE"))] <- 1
model.data$`Operational Adequacy Factor`[(model.data$Asset_Register_Category=="LV UGB") && (model.data$`Operational Adequacy Factor` %in% c("INOPERABLE"))] <- 1.5
## LV Pillars
model.data$`Operational Adequacy Factor`[(model.data$Asset_Register_Category=="LV Pillars") && (model.data$`Operational Adequacy Factor` %in% c("OPERABLE"))] <- 1
model.data$`Operational Adequacy Factor`[(model.data$Asset_Register_Category=="LV Pillars") && (model.data$`Operational Adequacy Factor` %in% c("INOPERABLE - SECURE"))] <- 1.3
model.data$`Operational Adequacy Factor`[(model.data$Asset_Register_Category=="LV Pillars") && (model.data$`Operational Adequacy Factor` %in% c("INOPERABLE - HAZARDOUS"))] <- 1.5

model.accepts <- c(1, 1.3, 1.5, 1.6)
model.default <- 1

operation.ad.default <- sum(!(model.data$`Operational Adequacy Factor` %in% model.accepts) | model.data$`Operational Adequacy Factor` == "Default")

model.data$`Operational Adequacy Factor` <- ifelse(model.data$`Operational Adequacy Factor` %in% model.accepts,
                                            model.data$`Operational Adequacy Factor`,
                                            model.default)
```

```{r security infill, warning=FALSE, echo=FALSE, message = FALSE}
model.data$`Security Factor` <- gsub("\\n", "", model.data$`Security Factor`)
model.data$`Security Factor` <- toupper(model.data$`Security Factor`)
model.data$`Security Factor`[model.data$`Security Factor` %in% c("SATISFACTORY")] <- 1
model.data$`Security Factor`[model.data$`Security Factor` %in% c("UNSATISFACTORY")] <- 1.3

model.accepts <- c(1, 1.3)
model.default <- 1

security.default <- sum(!(model.data$`Security Factor` %in% model.accepts) | model.data$`Security Factor` == "Default")

model.data$`Security Factor` <- ifelse(model.data$`Security Factor` %in% model.accepts,
                                            model.data$`Security Factor`,
                                            model.default)
```

```{r rel mod infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 1

reliability.modifier.default <- sum(is.na(as.numeric(model.data$`Reliability Modifier`)))
reliability.modifier.outside.range <- sum(model.data$`Reliability Modifier` < 0.6 | model.data$`Reliability Modifier` > 1.5)
reliability.modifier.outside.range <- ifelse(is.na(reliability.modifier.outside.range), 0, reliability.modifier.outside.range)

model.data$`Reliability Modifier` <- pmin(pmax(model.data$`Reliability Modifier`, 0.6), 1.5)

model.data$`Reliability Modifier` <- ifelse(!is.na(as.numeric(model.data$`Reliability Modifier`)),
                                    model.data$`Reliability Modifier`,
                                    model.default)
```

```{r rel col infill, warning=FALSE, echo=FALSE, message = FALSE}
model.default <- 0.5

model.data$`Reliability Collar` <- gsub(",", ".", model.data$`Reliability Collar`)

reliability.collar.default <- sum(is.na(as.numeric(model.data$`Reliability Collar`)))

model.data$`Reliability Collar` <- ifelse(!is.na(as.numeric(model.data$`Reliability Collar`)),
                                    model.data$`Reliability Collar`,
                                    model.default)
```

## Default Counts

Any fields which are infilled during the process are assessed for default values below. Additionally, `r reliability.modifier.outside.range` switchgear units are outside the required range of 0.6 to 1.5.

```{r summary, warning=FALSE, echo=FALSE, message = FALSE}
columns.infilled <- unique(names(model.data))[!(unique(names(model.data)) %in% c("Area1", "Type",
                                          "Asset_Number", "X", "Y",
                                          "Type_Factor", "DRFTMRK", "Evonet_Group"))]

infilling.summary <- data.frame(`Model Name` = columns.infilled,
                                `Asset Count Default` = c(coast.side.default,
                                                          health.category.default,
                                                          asset.category.default,
                                                          voltage.default,
                                                          year.default,
                                                          altitude.default,
                                                          corrosion.default,
                                                          distance.default,
                                                          position.default,
                                                          access.financial.default,
                                                          location.safety.default,
                                                          type.safety.default,
                                                          type.fin.default,
                                                          connected.customers.default,
                                                          customer.sensitivity.default,
                                                          kva.default,
                                                          top.30.customers.default,
                                                          quantity.default,
                                                          external.cond.default,
                                                          internal.cond.default,
                                                          compound.leaks.default,
                                                          insulation.default,
                                                          signs.of.heating.default,
                                                          phase.barriers.default,
                                                          operation.ad.default,
                                                          security.default,
                                                          reliability.modifier.default,
                                                          reliability.collar.default),
                                check.names = F)

kable(infilling.summary, "html") %>%
  kable_styling(bootstrap_options = c("striped", "condensed"))
```


```{r GIS input csv, warning=FALSE, echo=FALSE, message = FALSE, include = FALSE}
shape.file <- data.table(assets)

shape.file <- shape.file[!is.na(as.numeric(shape.file$X)) & !is.na(as.numeric(shape.file$Y))]

shape.file[, wkt_raw := paste0("POINT (", shape.file$X, " ", shape.file$Y, ")")]

shape.file <- st_as_sf(shape.file, wkt = "wkt_raw")



# Shape file must be in WGS84 projection for Qlik. EPSG code 4326
st_crs(shape.file) <- 25832
st_crs(shape.file)

# Set projection to WGS84
shape.file <- st_transform(shape.file, crs = 4326)

# Shape file must not have a z dimension to the geometry
# Remove z dimension
shape.file <- st_zm(shape.file)

# Use sf function to add new column with WKT (well-known text) geometry
shape.file.wkt <- shape.file %>%
  mutate(wkt_transformed = st_as_text(shape.file$wkt_raw))

# Use QlikLineFormat function to convert the WKT to format required by Qlik.
data.for.qlik <- shape.file.wkt %>%
  mutate(qlikpoint = QlikLineFormat(wkt_transformed))

# Remove shape file geometry and WKT
st_geometry(data.for.qlik) <- NULL
data.for.qlik$wkt_raw <- NULL
data.for.qlik$wkt_transformed <- NULL

gis.data.for.qlik <- strsplit(data.for.qlik$qlikpoint, ",")
gis.data.for.qlik.x <- unlist(lapply(gis.data.for.qlik, function(x) gsub("\\[", "", x[1])))
gis.data.for.qlik.y <- unlist(lapply(gis.data.for.qlik, function(x) gsub("\\]", "", x[2])))

data.for.qlik <- data.table(data.for.qlik)

data.for.qlik <- data.for.qlik[, .(AssetID = Asset_Number, DRFTMRK = DRFTMRK, X = gis.data.for.qlik.x, Y = gis.data.for.qlik.y)]

# Write csv of data for import to Qlik
write_csv(data.for.qlik, args[5]) ## this needs to be an extra output from the 
## R script and should be the following:
## Asset_Number, X, Y and Driftsmrk
```

```{r export, warning=FALSE, echo=FALSE, message = FALSE}

write_csv(model.data, args[4])

```


